
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">


<style>
body {
	background-color: white;

}

path {
  fill: #ccc;
  stroke: #000;
  shape-rendering: optimizeSpeed;
}

text {
	font-family: verdana;
	font-size: 11pt;
	fill: black;
}

circle {
	fill: rgb(0,115,130);
	cursor: pointer;
	stroke: white;
	stroke-width: 2.2px;
}

.container {
	display: inline-block;
	position: relative;
	width: 100%;
	padding-bottom: 57%;
	vertical-align: middle;
	overflow: hidden;
}

.content {
	display: inline-block;
	position: absolute;
	top: 0;
	left: 0;
}

/*@font-face {
    font-family: myriadproregular;
    src: url("myriadproregular.woff") format("woff");
}

body {
	background-color: rgb(255,255,255);

}

path {
  fill: #ccc;
  stroke: #000;
  shape-rendering: optimizeSpeed;
}

.axis path, .axis line {
	opacity: 0;
}

text {
	font-family: verdana;
	font-size: 11pt;

	
	fill: rgb(230,230,230);
}



circle {
	fill: rgb(80,80,255);
	cursor: pointer;
	stroke: white;
	stroke-width: 2.2px;
}



.countrytext {
	font-size:16pt;
}


.tooltip {
	font-family: verdana;
	position: absolute;
        display: block;
	opacity: 0;
        color: white;
        background-color: rgb(20,20,20);
        padding: 3px 6px 6px 6px;
        pointer-events: none;
        border-radius: 2px;
	z-index: 1000;
}

.tooltip2 {
	margin: 3px;
	padding: 0px;
	font-size: 12pt;
	font-weight: 600;
	width:100%;
	display: inline;
}

.tooltip3, .tooltip4 {
	margin: 3px;
	padding: 0px;
	font-size: 10pt;
	font-weight: 400;
}

.box {
	position: absolute;
	text-align: center;
	background-color: transparent;
	top: 20px;
	left: 0px;
	width: 350px;
	height: 100px;
        margin: 0px;
        padding: 0px;

}

.pagetitle {
	opacity: 1;
	font-family: verdana;
	font-size: 19pt;
	position: relative;
	text-align: center;
	font-weight: 900;
        color: rgb(230,230,230);
        background-color: transparent;
        pointer-events: none;
        margin: 0px;
        padding: 0px;
      
}

.amount {
	font-family: verdana; 
        margin: 0px;
        padding: 0px;
        font-size: 20pt;
        fill: orange;
        font-weight: 900;

}
.total {
	opacity: 0;
	position: relative;
	text-align: center;
	top: 0px;
	font-family: verdana;
	font-size: 10pt;
	font-weight: 100;
	color: rgb(230,230,230);
	text-shadow: none;
        margin: 0px;
        padding: 0px;
}
.measure {

	font-family: verdana;
	text-align: center;
	font-size: 18pt;
	position: absolute;

	left: 600px;
        color: black;
        background-color: transparent;
        width: 100%;
        
}

.container {
	display: inline-block;
	position: relative;
	width: 100%;
	padding-bottom: 57%;
	vertical-align: middle;
	overflow: hidden;
}

.content {
	display: inline-block;
	position: absolute;
	top: 0;
	left: 0;
}*/

</style>
<title>Animated Cartogram Example - Metrocosm</title>
</head>
<body>
<script src="https://metrocosm.com/js/d3.v3.min.js"></script>
<script src="https://metrocosm.com/js/d3.geo.projection.min.js"></script>
<script src="https://metrocosm.com/js/pym.js"></script>
<!--<div class="tooltip" style="border-radius: 3px; padding: 3px; left: 232px; top: 266px; opacity: 0;">
	<p class="tooltip2" style="font-size: 16pt; margin: 5px;">United States</p>
	<div class="tooltip3" style="font-size: 14pt; margin: 5px;">GDP: $16.8 trillion</div>
	<div class="tooltip4" style="font-size: 14pt; margin: 5px;">22.3% of total</div>
</div> -->


<div style="padding-left:50px;padding-right:50px;padding-top:0px;">
<div class="container">
	<svg version="1.1" viewBox="0 0 1040 600" preserveAspectRatio="xMinYMin meet" class="content">
	</svg>
</div>
</div>
<script>
var pymChild = null;

var widthf = 1000;
var heightf = widthf * 0.6;
var dimratio = widthf / 1000;


	var w = window,
	    d = document,
	    e = d.documentElement,
	    g = d.getElementsByTagName('body')[0];
		

	var wratio = ( w.innerWidth || e.clientWidth || g.clientWidth )*0.9 / 1000;


var colors = {1142034004: "#002f35",1150155040: "#002f35",1142145031: "#002f35",1019029044: "#002f35",1150155056: "#002f35",1019013084: "#002f35",1019005076: "#002f35",1002011854: "#002f35",1019021124: "#002f35",1019005152: "#002f35",1142030156: "#002f35",1019005170: "#002f35",1019013188: "#002f35",1150039191: "#002f35",1150151203: "#002f35",1019029214: "#002f35",1019005218: "#002f35",1019013222: "#002f35",1150155250: "#002f35",1150155276: "#002f35",1150039300: "#002f35",1019013320: "#002f35",1019005328: "#002f35",1019029332: "#002f35",1019013340: "#002f35",1142034356: "#002f35",1142145368: "#002f35",1150154372: "#002f35",1150039380: "#002f35",1019029388: "#002f35",1142030392: "#002f35",1142145400: "#002f35",1142030408: "#002f35",1142030408: "#002f35",1142145414: "#002f35",1142143417: "#002f35",1002015434: "#002f35",1150155442: "#002f35",1002011466: "#002f35",1019013484: "#002f35",1002015504: "#002f35",1142035104: "#002f35",1002018516: "#002f35",1150155528: "#002f35",1019013558: "#002f35",1142145512: "#002f35",1142034586: "#002f35",1019013591: "#002f35",1019005600: "#002f35",1019005604: "#002f35",1150151616: "#002f35",1142145634: "#002f35",1150151643: "#002f35",1142145682: "#002f35",1150039705: "#002f35",1002018710: "#002f35",1150039724: "#002f35",1019005740: "#002f35",1150155756: "#002f35",1142145792: "#002f35",1142145784: "#002f35",1150154826: "#002f35",1142035704: "#002f35"};

var width = 1000 * dimratio;
var height = 570 * dimratio;

var svg = d3.select("svg");


d3.select(".pagetitle").attr("x",175).attr("y",40).attr("text-anchor","middle");
d3.select(".amount").attr("x",175).attr("y",80).attr("text-anchor","middle");
d3.select(".total").attr("x",175).attr("y",100).attr("text-anchor","middle");






	d3.select(".tooltip").style("border-radius",(d3.round(2*wratio)) + "px").style("padding",(d3.round(2*wratio)) + "px");
	d3.select(".tooltip2").style("font-size",(d3.round(12*wratio)) + "pt").style("margin",(d3.round(4*wratio)) + "px");
	d3.select(".tooltip3").style("font-size",(d3.round(10*wratio)) + "pt").style("margin",(d3.round(4*wratio)) + "px");
	d3.select(".tooltip4").style("font-size",(d3.round(10*wratio)) + "pt").style("margin",(d3.round(4*wratio)) + "px");




var projection = d3.geo.miller()
    .scale(140 * dimratio)  //140
    .translate([width / 2 + 60*dimratio, height / 2 + 80*dimratio])
    .center([30.6, 13.9])
    .precision(.1);






d3.json("https://metrocosm.com/globalnone.geojson", function(polygon) { 
d3.json("https://metrocosm.com/globalgdp.geojson", function(polygon2) {
d3.json("https://metrocosm.com/globalpop.geojson", function(polygon3) {
d3.json("https://metrocosm.com/globalwealth.geojson", function(polygon4) {
d3.json("https://metrocosm.com/globalbirths.geojson", function(polygon5) {
d3.json("https://metrocosm.com/billionaires2.geojson", function(polygon6) {
d3.json("https://metrocosm.com/globaldebt.geojson", function(polygon7) {


	var path = svg.append("path");	
	var path1 = svg.append("path");
	
	var countries = polygon.features.length;
	alignfeatureorder(polygon, polygon2); 
	alignfeatureorder(polygon3, polygon4);
	alignfeatureorder(polygon5, polygon6);	
	alignfeatureorder(polygon7, polygon);	
	
	
	
	var k = -1;

	
	var line1 = [];
	var line2 = [];
	var line3 = [];
	var line4 = [];
	var line5 = [];
	var line6 = [];
	var line7 = [];

	var avgpoints = 0;
	

	
	var mostpoints;
	var rotation;
	while (k++ < (countries - 1)) {
			
		  line1 = polygon.features[k].geometry.coordinates[0];
		  line2 = polygon2.features[k].geometry.coordinates[0];
		  line3 = polygon3.features[k].geometry.coordinates[0];
		  line4 = polygon4.features[k].geometry.coordinates[0];		  
		  line5 = polygon5.features[k].geometry.coordinates[0];
		  line6 = polygon6.features[k].geometry.coordinates[0];
		  line7 = polygon7.features[k].geometry.coordinates[0];			  
		 
		  mostpoints = Math.max(line1.length, line2.length, line3.length, line4.length, line5.length, line6.length, line7.length);
		  
		  if (line1.length == mostpoints) {
		  	line2 = addpts(line2, 0, line2.length, line1.length);
		  	line3 = addpts(line3, 0, line3.length, line1.length);
		  	line4 = addpts(line4, 0, line4.length, line1.length);
		  	line5 = addpts(line5, 0, line5.length, line1.length);
		  	line6 = addpts(line6, 0, line6.length, line1.length);
		  	line7 = addpts(line7, 0, line7.length, line1.length);		  	
		  } else if (line2.length == mostpoints) {
		  	line1 = addpts(line1, 0, line1.length, line2.length);
		  	line3 = addpts(line3, 0, line3.length, line2.length);
		  	line4 = addpts(line4, 0, line4.length, line2.length);
		  	line5 = addpts(line5, 0, line5.length, line2.length);
		  	line6 = addpts(line6, 0, line6.length, line2.length);
		  	line7 = addpts(line7, 0, line7.length, line2.length);		  			  	
		  } else if (line3.length == mostpoints) {
		  	line1 = addpts(line1, 0, line1.length, line3.length);
		  	line2 = addpts(line2, 0, line2.length, line3.length);
		  	line4 = addpts(line4, 0, line4.length, line3.length);
		  	line5 = addpts(line5, 0, line5.length, line3.length);
		  	line6 = addpts(line6, 0, line6.length, line3.length);
		  	line7 = addpts(line7, 0, line7.length, line3.length);		  			  	
		  } else if (line4.length == mostpoints) {
		  	line1 = addpts(line1, 0, line1.length, line4.length);
		  	line2 = addpts(line2, 0, line2.length, line4.length);
		  	line3 = addpts(line3, 0, line3.length, line4.length);
		  	line5 = addpts(line5, 0, line5.length, line4.length);
		  	line6 = addpts(line6, 0, line6.length, line4.length);
		  	line7 = addpts(line7, 0, line7.length, line4.length);		  		 
		  } else if (line5.length == mostpoints) {
		  	line1 = addpts(line1, 0, line1.length, line5.length);
		  	line2 = addpts(line2, 0, line2.length, line5.length);
		  	line3 = addpts(line3, 0, line3.length, line5.length);
		  	line4 = addpts(line4, 0, line4.length, line5.length);
		  	line6 = addpts(line6, 0, line6.length, line5.length);
		  	line7 = addpts(line7, 0, line7.length, line5.length);		  		 
		  } else if (line6.length == mostpoints) {
		  	line1 = addpts(line1, 0, line1.length, line6.length);
		  	line2 = addpts(line2, 0, line2.length, line6.length);
		  	line3 = addpts(line3, 0, line3.length, line6.length);
		  	line4 = addpts(line4, 0, line4.length, line6.length);
		  	line5 = addpts(line5, 0, line5.length, line6.length);
		  	line7 = addpts(line7, 0, line7.length, line6.length);
		  } else {
		  	line1 = addpts(line1, 0, line1.length, line7.length);
		  	line2 = addpts(line2, 0, line2.length, line7.length);
		  	line3 = addpts(line3, 0, line3.length, line7.length);
		  	line4 = addpts(line4, 0, line4.length, line7.length);
		  	line5 = addpts(line5, 0, line5.length, line7.length);
		  	line6 = addpts(line6, 0, line6.length, line7.length);		  		 
		  }
		  
		  polygon.features[k].geometry.coordinates[0] = line1;
		  polygon2.features[k].geometry.coordinates[0] = line2;
		  polygon3.features[k].geometry.coordinates[0] = line3;
		  polygon4.features[k].geometry.coordinates[0] = line4;
		  polygon5.features[k].geometry.coordinates[0] = line5;
		  polygon6.features[k].geometry.coordinates[0] = line6;
		  polygon7.features[k].geometry.coordinates[0] = line7;		  			 

		  
		  rotation = calcrotation(line1, line2);
		  polygon2.features[k].geometry.coordinates[0] = rotatearray(polygon2.features[k].geometry.coordinates[0], -rotation);
		  rotation = calcrotation(line1, line3);
		  polygon3.features[k].geometry.coordinates[0] = rotatearray(polygon3.features[k].geometry.coordinates[0], -rotation);		  
		  rotation = calcrotation(line1, line4);
		  polygon4.features[k].geometry.coordinates[0] = rotatearray(polygon4.features[k].geometry.coordinates[0], -rotation);
		  rotation = calcrotation(line1, line5);
		  polygon5.features[k].geometry.coordinates[0] = rotatearray(polygon5.features[k].geometry.coordinates[0], -rotation);
		  rotation = calcrotation(line1, line6);
		  polygon6.features[k].geometry.coordinates[0] = rotatearray(polygon6.features[k].geometry.coordinates[0], -rotation);		  
		  rotation = calcrotation(line1, line7);
		  polygon7.features[k].geometry.coordinates[0] = rotatearray(polygon7.features[k].geometry.coordinates[0], -rotation);


		  polygon.features[k].geometry.coordinates[0] = polygon.features[k].geometry.coordinates[0].map(projection);
		  polygon2.features[k].geometry.coordinates[0] = polygon2.features[k].geometry.coordinates[0].map(projection);
		  polygon3.features[k].geometry.coordinates[0] = polygon3.features[k].geometry.coordinates[0].map(projection);
		  polygon4.features[k].geometry.coordinates[0] = polygon4.features[k].geometry.coordinates[0].map(projection);
		  polygon5.features[k].geometry.coordinates[0] = polygon5.features[k].geometry.coordinates[0].map(projection);
		  polygon6.features[k].geometry.coordinates[0] = polygon6.features[k].geometry.coordinates[0].map(projection);
		  polygon7.features[k].geometry.coordinates[0] = polygon7.features[k].geometry.coordinates[0].map(projection);

		 
	
	}
	
		

	
	svg.selectAll("circle")
                .data([1,2,3,4,5,6,7])
                .enter()
                .append("circle")
		//.style("fill","lightblue")
		.attr("class", function(d){
			return "circle circle" + d;
		})
		.attr("r",20*dimratio)
		.attr("cx", function(d){
			return 450* dimratio + 80*(d-1)*dimratio;
		})
		.attr("cy",40*dimratio)
		.on("click", function(d){
			mapshift(d);
		});



	d3.select(".circle1")
		.style("fill","lightblue")
		.attr("r",24*dimratio);


	var selectedvariable = 1;
	
	function mapshift(n) {
		
		d3.selectAll(".circle")
			.transition()
			.duration(500)
			.style("fill","rgb(60,123,168)")
			.attr("r",20*dimratio);
			
		d3.select(".circle" + n)
			.transition()
			.duration(500)
			.style("fill","blue")
			.attr("r",24*dimratio);
	
		d3.selectAll(".summary")
			.style("opacity",1);
	
		selectedvariable = n;
	
		if (n==1) {normal();}
		if (n==2) {gdp();}
		if (n==3) {debt();}
		if (n==4) {pop();}
		if (n==5) {birth();}
		if (n==6) {wealth();}
		if (n==7) {billionaire();}
	}



	
	var x = d3.scale.ordinal()
	    .domain(["None", "GDP", "Debt", "Population", "Births", "Wealth", "Billionaires"])
	    .rangePoints([450 * dimratio, 930 * dimratio]);
	
	var xAxis = d3.svg.axis()
	    .scale(x)
	    .orient("bottom");
	
	svg.append("g")
	    .attr("class", "x axis")
	    .call(xAxis)
	    .attr("transform", "translate(0," + (60*dimratio) + ")");


	
		var pathn = d3.geo.path().projection(null);
	

	                var tempmap = svg.selectAll("pathx")
	                   .data(polygon.features)
	                   .enter()
	                   .append("path")
	                   .attr("d", pathn)
	                   .style("stroke", "white")
	                   .style("stroke-width", 0.6)
	                   .style("fill", function(d){
	                   	return colors[d.properties.code];
	                   })
	                   .attr("class","country")
	                   .on("mousemove", function(d){
	                   	mouseover(d.properties);
	                   })
	                   .on("mouseout", function(d){
	                   	mouseout(d.properties.code);
	                   });
	      

	normal();

	function normal(){
			tempmap.data(polygon.features).transition().duration(2000).attr("d", pathn);

			d3.select(".pagetitle")
				.text("Select a variable");
			d3.selectAll(".summary")
				.style("opacity",0);	
			
	}
	function gdp(){
			tempmap.data(polygon2.features).transition().duration(2000).attr("d", pathn);

			d3.select(".pagetitle")
				.text("Aggregate GDP");
			d3.select(".amount")
				.text("$75.9 trillion");
			
			
			
	}
	function pop(){
			tempmap.data(polygon3.features).transition().duration(2000).attr("d", pathn);

			d3.select(".pagetitle")
				.text("Population");
			d3.select(".amount")
				.text("7.2 billion");
		
	}
	function wealth(){
			tempmap.data(polygon4.features).transition().duration(2000).attr("d", pathn);

			d3.select(".pagetitle")
				.text("Personal Wealth");
			d3.select(".amount")
				.text("$261.8 trillion");
			
	}    
	function birth(){
			tempmap.data(polygon5.features).transition().duration(2000).attr("d", pathn);
			
			d3.select(".pagetitle")
				.text("Births in 2014");
			d3.select(".amount")
				.text("134.4 million");			
	}
	function billionaire(){
			tempmap.data(polygon6.features).transition().duration(2000).attr("d", pathn);

			d3.select(".pagetitle")
				.text("Billionaires");
			d3.select(".amount")
				.text("2,390");
			
	}
	function debt(){
			tempmap.data(polygon7.features).transition().duration(2000).attr("d", pathn);

			d3.select(".pagetitle")
				.text("Government Debt");
			d3.select(".amount")
				.text("$56.9 trillion");			
	}  	
	

	function updatevalue(d){
		var val;
		var val2
	
		if (selectedvariable==1) {return ["",""];}
		else if (selectedvariable==2) {
			if (d.GDP == 0) {val = "Total wealth: N/A ";}
			else if (d.GDP > 1000) {val = "GDP: " + d3.format("$0,000.1")(d3.round(d.GDP /1000,1)) + " trillion";}
			else if (d.GDP  > 0) {val = "GDP: " + d3.format("$0,000.1")(d.GDP) + " billion";}
			else {val = "error";}	
			val2 = d.GDP / 75240;
		}
		else if (selectedvariable==3) {
			if (d.debt == 0) {val = "Debt: N/A ";}
			else if (d.debt > 100000) {val = "Debt: " + d3.format("$0,000.1")(d3.round(d.debt/100000,1)) + " trillion";}
			else if (d.debt > 100) {val = "Debt: " + d3.format("$0,000.1")(d3.round(d.debt/100,1)) + " billion";}
			else {val = "error";}
			val2 = d.debt / 5687481;			
		}
		else if (selectedvariable==4) {
			if (d.pop == 0) {val = "Population: N/A ";}
			else if (d.pop > 1000000) {val = "Population: " + d3.format("0,000.1")(d3.round(d.pop/1000000,1)) + " billion";}
			else if (d.pop > 1000) {val = "Population: " + d3.format("0,000.1")(d3.round(d.pop/1000,1)) + " million";}
			else if (d.pop > 0) {val = "Population: " + d3.format("0,000.1")(d.pop) + " thousand";}
			else {val = "error";}
			val2 = d.pop / 7200000;
		}
		else if (selectedvariable==5) {
			if (d.births == 0) {val = "Births: N/A ";}
			else if (d.births > 1000) {val = "Births: " + d3.format("0,000.1")(d3.round(d.births/1000,1)) + " million";}
			else if (d.births > 0) {val = "Births: " + d3.format("0,000.1")(d.births) + " thousand";}
			else {val = "error";}
			val2 = d.births / 137139;
		}
		else if (selectedvariable==6) {
			if (d.wealth == 0) {val = "Wealth: N/A ";}
			else if (d.wealth > 1000) {val = "Wealth: " + d3.format("$0,000.1")(d3.round(d.wealth /1000,1)) + " trillion";}
			else if (d.wealth  > 0) {val = "Wealth: " + d3.format("$0,000.1")(d.wealth ) + " billion";}
			else {val = "error";}
			val2 = d.wealth / 262000;
		}
		else {
			val = "Billionaires: " + d.billionair;
			val2 = d.billionair / 2390;
		}

		
		return [val, d3.format("0.1%")(val2) + " of total"];
	}
	
	               
	function mouseover(properties){
		var code = properties.code;
		var name = properties.name;
		var quantity = updatevalue(properties);
		
		d3.selectAll(".country")
			.filter(function(d){
				return d.properties.code == code;				
			})
			//.transition()
			//.duration(300)
			.style("fill","white");

		var xpos = d3.event.pageX + 10;
		var ypos = d3.event.pageY + 20;
			
		d3.select(".tooltip2")
			.text(name);
			
		d3.select(".tooltip3")
			.text(quantity[0]);
		
		d3.select(".tooltip4")
			.text(quantity[1]);
		
		d3.selectAll(".tooltip")
	                .style("left", xpos + "px")
	                .style("top", ypos + "px")
			.transition()
			.duration(150)
			.style("opacity",0.8);

			
		
	 
	}
	function mouseout(code){
		
		d3.selectAll(".country")
			.filter(function(d){
				return d.properties.code == code;
			})
	                .style("fill", function(d){
	                   	return colors[d.properties.code];
	                });
	                
	        d3.selectAll(".tooltip").transition().duration(150)
			.style("opacity",0);
	 
	}	
	

	
	

	  
	  
});
});
});
});
});
});
});







function addpts(linearr, startp, counts, counte) {
    var linearrnew = linearr;
    var i = -1;
    var addnum = - counts + counte;
    var spacing = counts / (addnum + 1);
    var addindex;
    var priorindex;
    var newval0;
    var newval1;
 

    
    while (++i < addnum) {
    	addindex = (startp + Math.round((i+1)*spacing) + i+1) % linearrnew.length;
    	if (addindex == 0) {addindex = 1;}
    	priorindex = (addindex - 1  + linearrnew.length) % linearrnew.length;

    	newval0 = (linearrnew[priorindex][0] + linearrnew[addindex][0])/2;
    	newval1 = (linearrnew[priorindex][1] + linearrnew[addindex][1])/2 + 0.00000000001;

        linearrnew.splice(addindex, 0, [newval0, newval1]);

    }

    
    return linearrnew;
}



function rotatearray(a, inc) {
    a.splice(0,1)
    for (var l = a.length, inc = (Math.abs(inc) >= l && (inc %= l), inc < 0 && (inc += l), inc), i, x; inc; inc = (Math.ceil(l / inc) - 1) * inc - l + (l = inc))
    for (i = l; i > inc; x = a[--i], a[i] = a[i - inc], a[i - inc] = x);

    a.splice(0,0,a[a.length-1]);

     return a;
};



function alignfeatureorder(poly1, poly2) {
	var i = 0;
	var j = 0;
	var tempfeature;
	var n = poly1.features.length;
	
	while (++i < n) {
			j = 0;
			
			while (++j < n) {
				
				if (+poly1.features[j-1].properties.ID > +poly1.features[j].properties.ID){
				
					tempfeature = poly1.features[j-1];
					poly1.features[j-1] = poly1.features[j];
					poly1.features[j] = tempfeature;
				}
				if (+poly2.features[j-1].properties.ID > +poly2.features[j].properties.ID){
					
					tempfeature = poly2.features[j-1];
					poly2.features[j-1] = poly2.features[j];
					poly2.features[j] = tempfeature;
				}
		
			}

	}


	return [poly1, poly2];

}


function calcrotation(line1, line2) {
	var l1 = line1;
	var l2 = line2;
	var len = line1.length;
	var i;
	var j;
	temparr = [];
	resultarr = [];
	var mindist = [-9999,9999];
	
	for (i = 0; i < len; i++){
		for (j = 0; j < len; j++){
		
			temparr[j] = dist(l1[j], l2[(i + j) % len]);
		
		
		}	
		resultarr[i] = avg(temparr);

		if (resultarr[i][0] < mindist[1]) {
			mindist[0] = i;
			mindist[1] = resultarr[i][0];
		}
	}
		

	return mindist[0];
}


function dist(p1, p2){

	return Math.sqrt((p1[0] - p2[0])*(p1[0] - p2[0]) + (p1[1] - p2[1])*(p1[1] - p2[1]));
	
}

function avg(arr) {
	var i;
	var tot = 0;
	var avg1 = 0;
	var stdv = 0;
	
	for (i = 0; i < arr.length; i++){
		tot = tot + arr[i]
	}
	
	avg1 = tot / arr.length;
	tot = 0;
	for (i = 0; i < arr.length; i++){
		tot = (arr[i] - avg1) * (arr[i] - avg1);
	}
	tot = tot / (arr.length - 1);
	
	stdv = Math.sqrt(tot);
	
	return [avg1, stdv];
	
}


pymChild = new pym.Child();
</script>

<script>


var pymChild = null;  //******this plugin is for making dynamic iframes - unrelated to the mapping



var width = 1000;
var height = 570;

var svg = d3.select("svg");

var projection = d3.geo.miller()
    .scale(140)
    .translate([width / 2 + 60, height / 2 + 80])
    .center([30.6, 13.9])
    .precision(.1);


d3.json("basemap.json", function(polygon) {
d3.csv("def_grid.csv", function(error, shift1) { 


	
	var countries = polygon.features.length;

	function modifypoly(polyline,shift){   //	***********create cartogram using deformation grid************
		var l1 = polyline;
		var len = l1.length;
		var i;
		var j;
		temparr = [];
		resultarr = [];

		var xintermed1;
		var xintermed2;
		var yintermed1;
		var yintermed2;
		var xfinal;
		var yfinal;
			
		var xinterp = d3.scale.linear();
		var yinterp = d3.scale.linear();
				
			for (j = 0; j < len; j++){    //*****adjust the points one-by-one*****
				
				var x1y1 = (Math.floor(l1[j][1]*50/180) + 50)*100 + Math.floor(l1[j][0]*50/180) + 50;
				var x1y2 = (Math.floor(l1[j][1]*50/180) + 50 + 1)*100 + Math.floor(l1[j][0]*50/180) + 50;		
				var x2y1 = (Math.floor(l1[j][1]*50/180) + 50)*100 + Math.floor(l1[j][0]*50/180) + 50 + 1;
				var x2y2 = (Math.floor(l1[j][1]*50/180) + 50 + 1)*100 + Math.floor(l1[j][0]*50/180) + 50 + 1;				
				

				xinterp
					.domain([Math.floor(l1[j][0]*50/180), Math.floor(l1[j][0]*50/180)+1])
					.range([shift[x1y1].dx,shift[x2y1].dx]);
				xintermed1 = xinterp(l1[j][0]*50/180);

				xinterp
					.range([shift[x1y2].dx,shift[x2y2].dx]);
				xintermed2 = xinterp(l1[j][0]*50/180);
					
				xinterp
					.range([shift[x1y1].dy,shift[x2y1].dy]);
				yintermed1 = xinterp(l1[j][0]*50/180);	
												
				xinterp
					.range([shift[x1y2].dy,shift[x2y2].dy]);
				yintermed2 = xinterp(l1[j][0]*50/180);				
				

				
				yinterp
					.domain([Math.floor(l1[j][1]*50/180), Math.floor(l1[j][1]*50/180) + 1])
					.range([xintermed1,xintermed2]);
				xfinal = +yinterp(l1[j][1]*50/180);
				
				yinterp					
					.range([yintermed1,yintermed2]);
				yfinal = +yinterp(l1[j][1]*50/180);

				l1[j][0] = +l1[j][0] + xfinal;
				l1[j][1] = +l1[j][1] + yfinal;
				
				if (l1[j][0] > 180){l1[j][0] = 179.99;}
				if (l1[j][1] > 180){l1[j][1] = 179.99;}
				if (l1[j][0] > 180){l1[j][0] = 179.99;}
				if (l1[j][1] > 180){l1[j][1] = 179.99;}				
			}
			
		return l1;				
	}
	
	
	
	var k = -1;
	var temppolygon = JSON.parse(JSON.stringify(polygon));   //make a copy of the basemap
	var polygon2 = JSON.parse(JSON.stringify(polygon));		

	while (k++ < (countries - 1)) {	  //***************deform the countries one-by-one
		  polygon2.features[k].geometry.coordinates[0] = modifypoly(temppolygon.features[k].geometry.coordinates[0],shift1);		  
	}

	k = -1;
	while (k++ < (countries - 1)) {     //****************convert geographic coordinates to SVG coordinates to prevent D3 from resampling
		  polygon.features[k].geometry.coordinates[0] = polygon.features[k].geometry.coordinates[0].map(projection);
		  polygon2.features[k].geometry.coordinates[0] = polygon2.features[k].geometry.coordinates[0].map(projection);	
	}
	
	
	
	svg.selectAll("circle")
                .data([1,2])
                .enter()
                .append("circle")
		.attr("class", function(d){
			return "circle circle" + d;
		})
		.attr("r",20)
		.attr("cx", function(d){
			return 400 + 141*(d-1);
		})
		.attr("cy",40)
		.on("click", function(d){
			mapshift(d);
		});

	d3.select(".circle1")
		.style("fill","rgb(0,47,53)")
		.attr("r",24);

	
	function mapshift(n) {		//switch maps
		
		d3.selectAll(".circle")
			.transition()
			.duration(500)
			.style("fill","rgb(0,115,130)")
			.attr("r",20);
			
		d3.select(".circle" + n)
			.transition()
			.duration(500)
			.style("fill","rgb(0,47,53)")
			.attr("r",30);
	
		if (n==1) {Original();}
		if (n==2) {Travel();}

	}


	svg.append("text")
		.attr("x", 400)
		.attr("y",84)
		.attr("text-anchor","middle")
		.text("World Map");

	svg.append("text")
		.attr("x", 400 + 150)
		.attr("y",84)
		.attr("text-anchor","middle")
		.text("Travel Cartogram");
	
					
	var pathn = d3.geo.path().projection(null);

	var worldmap = svg.selectAll("path")      //plot the map
	           .data(polygon.features)
	           .enter()
	           .append("path")
	           .attr("d", pathn)
	           .style("stroke", "rgb(50,50,50)")
	           .style("stroke-width", 0.6)
	           .style("fill", function(d){
	                   	return colors[d.properties.code];
	                   })
	                   .attr("class","country")
	                   .on("mousemove", function(d){
	                   	mouseover(d.Feature.name);
	                   })
	                   .on("mouseout", function(d){
	                   	mouseout(d.properties.code);
	                   });
	      
	      

	Original();
                              //************map transitions*********************
	function Original(){
		worldmap.data(polygon.features).transition().duration(2000).attr("d", pathn);
			
	}
	function Travel(){
		worldmap.data(polygon2.features).transition().duration(2000).attr("d", pathn);
			
	}
	  	  
});
});

pymChild = new pym.Child();

</script>
</body>
</html>